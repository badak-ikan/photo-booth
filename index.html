<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PB-SNAP Studio Pro Ultimate</title>
    <style>
        :root { --primary: #ff4757; --secondary: #2ed573; --dark: #2f3542; --light: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: #f1f2f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; }
        
        .app-container { background: var(--light); padding: 1.2rem; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 500px; box-sizing: border-box; }
        
        /* Viewport & Camera */
        .viewport-container { position: relative; width: 100%; background: #000; border-radius: 16px; overflow: hidden; margin-bottom: 10px; border: 4px solid #eee; display: flex; align-items: center; justify-content: center; }
        .portrait { aspect-ratio: 3/4; }
        .landscape { aspect-ratio: 4/3; }
        #video { width: 100%; height: 100%; object-fit: cover; transition: filter 0.3s; }
        .mirror { transform: scaleX(-1); } 
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; color: white; font-weight: 900; z-index: 10; text-shadow: 0 0 20px rgba(0,0,0,0.5); pointer-events: none; }
        .flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 20; pointer-events: none; }

        /* Settings UI */
        .settings-section { text-align: left; margin-bottom: 12px; }
        .option-label { font-size: 10px; font-weight: bold; color: #aaa; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .scroll-menu { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .scroll-menu::-webkit-scrollbar { display: none; }
        .btn-opt { padding: 8px 12px; border: 1px solid #ddd; border-radius: 10px; background: white; cursor: pointer; font-size: 11px; white-space: nowrap; flex-shrink: 0; }
        .btn-opt.active { background: var(--primary); color: white; border-color: var(--primary); }

        .watermark-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 14px; margin-top: 5px; outline: none; }

        #start-btn { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3); }

        /* Preview Modal */
        #preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #preview-img { max-height: 70vh; max-width: 100%; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div class="app-container">
    <div style="display:flex; gap:8px; margin-bottom:12px;">
        <button class="btn-opt" style="flex:1" onclick="switchCamera()">ðŸ”„ Ganti Kamera</button>
        <button class="btn-opt" style="flex:1" onclick="toggleOrientation()">ðŸ“± Putar Layar</button>
    </div>
    
    <div id="viewport" class="viewport-container portrait">
        <video id="video" autoplay playsinline muted class="mirror"></video>
        <div id="countdown"></div>
        <div id="flash" class="flash"></div>
    </div>

    <div class="settings-section">
        <span class="option-label">Filter Warna</span>
        <div class="scroll-menu">
            <button class="btn-opt active" onclick="setFilter('none', this)">Normal</button>
            <button class="btn-opt" onclick="setFilter('grayscale(100%)', this)">B&W</button>
            <button class="btn-opt" onclick="setFilter('sepia(60%) contrast(1.1)', this)">Vintage</button>
            <button class="btn-opt" onclick="setFilter('brightness(1.1) contrast(1.1) saturate(1.3)', this)">Retro</button>
            <button class="btn-opt" onclick="setFilter('hue-rotate(-10deg) saturate(0.8) contrast(1.1)', this)">Warm</button>
        </div>
    </div>

    <div class="settings-section">
        <span class="option-label">Watermark Kustom</span>
        <input type="text" id="watermark-text" class="watermark-input" placeholder="Tulis namamu di sini..." maxlength="25">
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="settings-section">
            <span class="option-label">Timer (2-5s)</span>
            <div class="scroll-menu">
                <button class="btn-opt" onclick="setTimer(2, this)">2s</button>
                <button class="btn-opt active" onclick="setTimer(3, this)">3s</button>
                <button class="btn-opt" onclick="setTimer(5, this)">5s</button>
            </div>
        </div>
        <div class="settings-section">
            <span class="option-label">Frame (2-6)</span>
            <div class="scroll-menu">
                <button class="btn-opt" onclick="setCount(2, this)">2</button>
                <button class="btn-opt active" onclick="setCount(4, this)">4</button>
                <button class="btn-opt" onclick="setCount(6, this)">6</button>
            </div>
        </div>
    </div>

    <div class="settings-section">
        <span class="option-label">Hiasan & Warna Frame</span>
        <div class="scroll-menu">
            <button class="btn-opt active" onclick="setDecor('none', this)">Polos</button>
            <button class="btn-opt" onclick="setDecor('ðŸ¦‹', this)">ðŸ¦‹</button>
            <button class="btn-opt" onclick="setDecor('âœ¨', this)">âœ¨</button>
            <button class="btn-opt" onclick="setColor('#ffffff', this)">âšª Putih</button>
            <button class="btn-opt" onclick="setColor('#2f3542', this)">âš« Hitam</button>
            <button class="btn-opt" onclick="setColor('#ffb6c1', this)">ðŸŒ¸ Pink</button>
        </div>
    </div>

    <button id="start-btn">MULAI SESI FOTO</button>
</div>

<div id="preview-modal">
    <img id="preview-img" src="">
    <div style="display:flex; gap:10px; width:100%; max-width:400px;">
        <button class="btn-opt" style="flex:1; padding:15px; background:#555; color:white;" onclick="closePreview()">ULANG</button>
        <a id="save-btn" class="btn-opt" style="flex:1; padding:15px; background:var(--secondary); color:white; text-align:center; text-decoration:none;">SIMPAN</a>
    </div>
</div>

<canvas id="canvas" style="display:none"></canvas>

<script>
    const video = document.getElementById('video');
    const viewport = document.getElementById('viewport');
    const canvas = document.getElementById('canvas');
    const previewModal = document.getElementById('preview-modal');
    const previewImg = document.getElementById('preview-img');
    const startBtn = document.getElementById('start-btn');
    const countdownEl = document.getElementById('countdown');
    const flashEl = document.getElementById('flash');
    const watermarkInput = document.getElementById('watermark-text');

    let stream = null, currentFacingMode = "user", currentOrientation = "portrait";
    let photos = [], currentTimer = 3, currentCount = 4, currentColor = '#ffffff', currentDecor = 'none', currentFilter = 'none';

    async function startCamera() {
        if (stream) stream.getTracks().forEach(track => track.stop());
        const constraints = { video: { facingMode: { ideal: currentFacingMode }, width: { ideal: 1280 }, height: { ideal: 720 } } };
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            video.className = currentFacingMode === "user" ? "mirror" : "";
        } catch (e) { alert("Izin kamera diperlukan."); }
    }

    function setFilter(f, btn) { currentFilter = f; video.style.filter = f === 'none' ? '' : f; updateActive(btn); }
    function switchCamera() { currentFacingMode = currentFacingMode === "user" ? "environment" : "user"; startCamera(); }
    function toggleOrientation() { currentOrientation = currentOrientation === "portrait" ? "landscape" : "portrait"; viewport.className = `viewport-container ${currentOrientation}`; }
    function setTimer(t, btn) { currentTimer = t; updateActive(btn); }
    function setCount(c, btn) { currentCount = c; updateActive(btn); }
    function setDecor(d, btn) { currentDecor = d; updateActive(btn); }
    function setColor(c, btn) { currentColor = c; updateActive(btn); }

    function updateActive(btn) {
        btn.parentElement.querySelectorAll('.btn-opt').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    startBtn.onclick = async () => {
        photos = []; startBtn.disabled = true;
        for (let i = 1; i <= currentCount; i++) {
            for (let c = currentTimer; c > 0; c--) {
                countdownEl.innerText = c;
                await new Promise(r => setTimeout(r, 1000));
            }
            countdownEl.innerText = "";
            flashEl.style.opacity = 1; setTimeout(() => flashEl.style.opacity = 0, 100);
            
            const snap = document.createElement('canvas');
            const ctx = snap.getContext('2d');
            snap.width = currentOrientation === "portrait" ? 600 : 800;
            snap.height = currentOrientation === "portrait" ? 800 : 600;

            if (currentFacingMode === "user") { ctx.translate(snap.width, 0); ctx.scale(-1, 1); }
            if (currentFilter !== 'none') ctx.filter = currentFilter;
            ctx.drawImage(video, 0, 0, snap.width, snap.height);
            photos.push(snap.toDataURL('image/jpeg', 0.9));
            await new Promise(r => setTimeout(r, 800));
        }
        renderResult();
    };

    function renderResult() {
        const ctx = canvas.getContext('2d');
        const imgW = (currentOrientation === "portrait") ? 600 : 800;
        const imgH = (currentOrientation === "portrait") ? 800 : 600;
        const gap = 40, margin = 70;
        const isDouble = currentCount >= 4;
        
        canvas.width = isDouble ? (margin * 2) + (imgW * 2) + gap : (margin * 2) + imgW;
        canvas.height = (margin * 2) + (Math.ceil(currentCount/(isDouble?2:1)) * (imgH + gap)) + 150;

        ctx.fillStyle = currentColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        photos.forEach((src, i) => {
            const img = new Image();
            img.src = src;
            img.onload = () => {
                let x = isDouble ? margin + (i % 2 * (imgW + gap)) : margin;
                let y = margin + (Math.floor(i / (isDouble?2:1)) * (imgH + gap));
                ctx.drawImage(img, x, y, imgW, imgH);
                if (currentDecor !== 'none') { ctx.font = "50px Arial"; ctx.fillText(currentDecor, x + 20, y + 75); }
                if (i === currentCount - 1) {
                    const isDark = currentColor === '#2f3542';
                    ctx.fillStyle = isDark ? '#fff' : '#333';
                    ctx.textAlign = "center";
                    ctx.font = "bold 42px Inter";
                    ctx.fillText((watermarkInput.value || "PB-SNAP STUDIO").toUpperCase(), canvas.width/2, canvas.height - 90);
                    ctx.font = "22px Inter";
                    ctx.fillText(new Date().toLocaleString('id-ID'), canvas.width/2, canvas.height - 50);
                    
                    previewImg.src = canvas.toDataURL('image/png');
                    document.getElementById('save-btn').href = previewImg.src;
                    document.getElementById('save-btn').download = `pb-snap.png`;
                    previewModal.style.display = 'flex';
                    startBtn.disabled = false;
                }
            };
        });
    }

    function closePreview() { previewModal.style.display = 'none'; }
    window.addEventListener('load', startCamera);
</script>
</body>
</html>
